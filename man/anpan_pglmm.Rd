% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pglmm.R
\name{anpan_pglmm}
\alias{anpan_pglmm}
\title{Run a phylogenetic generalized linear mixed model}
\usage{
anpan_pglmm(
  meta_file,
  tree_file = NULL,
  cor_mat = NULL,
  outcome,
  covariates = NULL,
  out_dir = NULL,
  trim_pattern = NULL,
  bug_name = NULL,
  omit_na = FALSE,
  family = "gaussian",
  show_plot_cor_mat = TRUE,
  show_plot_tree = TRUE,
  show_post = TRUE,
  show_yrep = FALSE,
  save_object = FALSE,
  verbose = TRUE,
  loo_comparison = TRUE,
  reg_noise = TRUE,
  reg_gamma_params = c(1, 2),
  plot_ext = "pdf",
  beta_sd = NULL,
  sigma_phylo_scale = 0.333,
  ...
)
}
\arguments{
\item{meta_file}{either a data frame of metadata or a path to file containing the metadata}

\item{tree_file}{either a path to a tree file readable by \code{\link[ape:read.tree]{ape::read.tree()}} or an object of
class "phylo" that is already read into R. Ignored if \code{cor_mat} is supplied.}

\item{cor_mat}{a correlation matrix provided as an alternative to a tree.}

\item{outcome}{the name of the outcome variable}

\item{covariates}{covariates to account for (as a vector of strings)}

\item{out_dir}{if saving, directory where to save}

\item{trim_pattern}{optional pattern to trim from tip labels of the tree}

\item{omit_na}{logical indicating whether to omit incomplete cases of the metadata}

\item{family}{string giving the name of the distribution of the outcome variable (usually
"gaussian" or "binomial")}

\item{show_plot_cor_mat}{show a plot of the correlation matrix derived from the tree}

\item{show_plot_tree}{show a plot of the tree overlaid with the outcome.}

\item{show_post}{show a plot of the tree overlaid with the outcome and posterior distribution on
phylogenetic effects.}

\item{show_yrep}{show a plot of the tree overlaid with the outcome and the posterior predictive
distribution for each observation if plotting the tree}

\item{save_object}{logical indicating whether to save the model fit object}

\item{loo_comparison}{logical indicating whether to compare the phylogenetic model against a base
model (without the phylogenetic term) using \code{\link[loo:loo_compare]{loo::loo_compare()}}}

\item{reg_noise}{logical indicating whether to regularize the ratio of sigma_phylo to sigma_resid
with a Gamma prior}

\item{reg_gamma_params}{the shape and rate parameters of the Gamma prior on the noise term ratio.
Default: c(1,2)}

\item{plot_ext}{extension to use when saving plots}

\item{beta_sd}{prior standard deviation parameters on the normal distribution for each covariate
in the GLM component}

\item{sigma_phylo_scale}{standard deviation of half-normal prior on \code{sigma_phylo} for
logistic PGLMMs when \code{family = 'binomial'}. Increasing this value can easily lead to
overfitting.}

\item{...}{other arguments to pass to \code{\link[cmdstanr:model-method-sample]{cmdstanr::sample()}}}
}
\value{
A list containing the model input (in the order passed to the model), estimated
correlation matrix, the pglmm fit object, and (if \code{loo_comparison} is on) the base fit
object and the associated loo objects.
}
\description{
Run a phylogenetic generalized linear mixed model
}
\details{
the tip labels of the tree must be the sample ids from the metadata. You can use the
\code{trim_pattern} argument to automatically trim off any consistent pattern from the tip
labels if necessary.

The dots can be used to pass e.g. parallel_chains=4 to make the chains run in parallel.

The prior for the intercept is a normal distribution centered on the mean of the outcome
variable with a standard deviation of 3*sd(outcome variable)

The default error distribution for the outcome is "gaussian". You could change this to a
phylogenetic logistic regression by changing \code{family} to "binomial" for example.

It's normal to see some warnings during warmup, particularly about "Scale vector is inf".

This function tries to get the \code{bug_name} argument from the tree file, but if it's not
provided you may need to set it yourself.

If using \code{beta_sd} with a categorical predictor with >2 levels, only specify a single
element in beta_sd. This appropriate element will get repeated as necessary.

Common cmdstanr options that one might want to pass in via ... include \code{refresh = 500}
(show fewer MCMC progress updates), \code{adapt_delta = .98} (avoid divergences at the cost of
possibly needing more iterations to get convergence) and \code{parallel_chains = 4} (run the
MCMC chains in parallel).

If you want to use the PGLMM log-likelihood data frame with functions from the \code{loo}
package, you'll need to convert it to a matrix with \code{as.matrix()}. It's converted to a
tibble internally so that it prints nicely.
}
\examples{
meta = data.frame(x = rnorm(100), sample_id = paste0("t", 1:100))
tr = ape::rtree(100)
anpan_pglmm(meta, tr,
outcome = "x",
iter_sampling = 10, # Use more in practice!
iter_warmup = 10,
show_plot_cor_mat = FALSE,
show_plot_tree = FALSE)
}
\seealso{
\code{\link[=anpan_pglmm_batch]{anpan_pglmm_batch()}}, \code{\link[loo:loo]{loo::loo()}}, \code{\link[cmdstanr:model-method-sample]{cmdstanr::sample()}}
}
